function toggleVoiceControl(event) {
  if (voiceControlActive) {
    stopVoiceControl(event);
  } else {
    startVoiceControl(event);
  }
}

function startVoiceControl(event) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("Speech recognition not supported in this browser.");
    return;
  }

  recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  voiceControlActive = true;
  document.getElementById("voice-status").textContent = "üé§ Listening...";
  event.target.textContent = "üõë Stop Voice Control";

  recognition.onresult = function(event) {
    const command = event.results[0][0].transcript.toLowerCase();
    console.log("Heard:", command);

    if (command.includes("on")) {
      socket.emit("bulb-command", "ON");
    } else if (command.includes("off")) {
      socket.emit("bulb-command", "OFF");
    } else {
      document.getElementById("voice-status").textContent = "ü§∑ Command not recognized.";
      return;
    }

    document.getElementById("voice-status").textContent = "‚úÖ Command processed. Listening...";
  };

  recognition.onerror = function(event) {
    console.error("Speech error:", event.error);
    document.getElementById("voice-status").textContent = "‚ùå Voice error: " + event.error;
  };

  recognition.onend = function() {
    if (voiceControlActive) {
      recognition.start();
    }
  };

  recognition.start();
}

function stopVoiceControl(event) {
  if (recognition) recognition.stop();
  voiceControlActive = false;
  event.target.textContent = "üé§ Start Voice Control";
  document.getElementById("voice-status").textContent = "Voice control stopped.";
}
