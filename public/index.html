<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Real-Time IoT Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
  <style>
    @keyframes fade-in { 
      from { opacity: 0; transform: translateY(10px); } 
      to { opacity: 1; transform: translateY(0); } 
    }
    .animate-fade-in { animation: fade-in 0.5s ease-out; }

    /* Bulb glow animation */
    @keyframes glow-pulse {
      0%, 100% { text-shadow: 0 0 8px #facc15, 0 0 16px #facc15, 0 0 24px #facc15; }
      50% { text-shadow: 0 0 12px #facc15, 0 0 20px #facc15, 0 0 28px #facc15; }
    }
    .bulb-on {
      color: #facc15;
      animation: glow-pulse 1.5s infinite ease-in-out;
      transition: color 0.3s ease;
    }
    .bulb-off {
      color: #9ca3af;
      animation: none;
      transition: color 0.3s ease;
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 font-sans min-h-screen">
  <header class="bg-gray-800 text-white text-center py-4 shadow-md dark:bg-gray-700">
    <h1 class="text-2xl font-bold">📡 IoT Dashboard</h1>
  </header>

  <main class="max-w-lg mx-auto mt-10 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 space-y-6 transition duration-500">
    <div id="dashboard" class="space-y-5 animate-fade-in flex flex-col items-center text-center">
      <div class="text-lg flex items-center gap-2">🌡️ Temperature:
        <span id="temperature" class="font-semibold text-orange-500">--</span> °C
      </div>
      <div class="text-lg flex items-center gap-2">💧 Humidity:
        <span id="humidity" class="font-semibold text-blue-500">--</span> %
      </div>
      <div class="text-lg flex items-center gap-2">💡 Bulb Status:
        <svg id="bulb-icon" class="w-6 h-6 bulb-off" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 2a7 7 0 0 0-7 7c0 3.31 2.69 6 6 6h2c3.31 0 6-2.69 6-6a7 7 0 0 0-7-7zm0 14v2h-2v2h4v-2h-2v-2z"/>
        </svg>
        <span id="bulb" class="font-semibold text-yellow-500">OFF</span>
      </div>
      <div class="flex flex-col sm:flex-row gap-4">
        <button id="bulbButton" onclick="toggleBulb()"
                class="flex-1 bg-red-500 text-white py-2 rounded-md font-medium flex items-center justify-center gap-2 transition transform hover:scale-105">
          Toggle Bulb
        </button>
        <button id="voiceControlButton" onclick="toggleVoiceControl(event)"
                class="bg-indigo-600 text-white py-2 px-4 rounded-md mt-4 hover:bg-indigo-700 transition">
          🎤 Start Voice Control
        </button>
        <p id="voice-status" class="text-sm text-gray-500 dark:text-gray-400 mt-2">
          Say "turn on bulb" or "turn off bulb"
        </p>
      </div>
    </div>
  </main>

  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script>
    let socket;
    let recognition;
    let voiceControlActive = false;

    // Toggle bulb manually
    function toggleBulb() {
      const current = document.getElementById("bulb").textContent;
      const newStatus = current === "ON" ? "OFF" : "ON";
      document.getElementById("bulbButton").disabled = true;
      socket.emit("bulb-command", newStatus);
    }

    // Voice control toggle
    function toggleVoiceControl(event) {
      voiceControlActive ? stopVoiceControl(event) : startVoiceControl(event);
    }

    function startVoiceControl(event) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) return alert("Speech recognition not supported.");

      recognition = new SpeechRecognition();
      recognition.lang = "en-US";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      voiceControlActive = true;
      document.getElementById("voice-status").textContent = "🎤 Listening...";
      event.target.textContent = "🛑 Stop Voice Control";

      recognition.onresult = e => {
        const command = e.results[0][0].transcript.toLowerCase();
        if (command.includes("on")) socket.emit("bulb-command", "ON");
        else if (command.includes("off")) socket.emit("bulb-command", "OFF");
        else { document.getElementById("voice-status").textContent = "🤷 Command not recognized."; return; }
        document.getElementById("voice-status").textContent = "✅ Command processed. Listening...";
      };

      recognition.onerror = e => {
        console.error("Voice error:", e.error);
        document.getElementById("voice-status").textContent = "❌ Voice error: " + e.error;
      };

      recognition.onend = () => { if (voiceControlActive) recognition.start(); };
      recognition.start();
    }

    function stopVoiceControl(event) {
      if (recognition) recognition.stop();
      voiceControlActive = false;
      event.target.textContent = "🎤 Start Voice Control";
      document.getElementById("voice-status").textContent = "Voice control stopped.";
    }

    // Update bulb UI
    function updateBulbUI(status) {
      const bulb = document.getElementById("bulb");
      const icon = document.getElementById("bulb-icon");

      bulb.textContent = status;
      icon.classList.toggle("bulb-on", status === "ON");
      icon.classList.toggle("bulb-off", status !== "ON");

      const btn = document.getElementById("bulbButton");
      btn.disabled = false;
      btn.classList.toggle('bg-red-500', status !== "ON");
      btn.classList.toggle('bg-green-500', status === "ON");
    }

    // Initialize dashboard
    function showDashboard() {
      socket = io();
      socket.on("update", data => {
        document.getElementById("temperature").textContent = data.temperature;
        document.getElementById("humidity").textContent = data.humidity;
        updateBulbUI(data.bulb);
      });
    }

    showDashboard();
  </script>
</body>
</html>
